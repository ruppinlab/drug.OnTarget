---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 
<!-- "Drug's specificity to its known target" (DSKT score) -->
<!-- Find if DSKT Score can explain the cancer types where the drug is approved -->
<!-- Scripts and data needed -->
```{r}
knitr::knit('/Users/sinhas8/Project_TrueTarget/Tools_github/3.Tools/Step0B_Data_and_Libraries.Rmd')
knitr::knit('/Users/sinhas8/Project_TrueTarget/Tools_github/3.Tools/Step0_Write_Functions.Rmd')
```


<!-- Provide query drug -->
```{r}
Query_Drug='erlotinib'
```
<!-- Note 1: Please write a script to provide all the synonyms of a given Query_Drug -->
<!-- Check if the drug is in our screens and if yes, please provide drugID -->
```{r}
Query_DrugID=match_stripall(Query_Drug, onTarget$drugCategory$name)
Query_DrugID_knownInfo=onTarget$drugCategory[Query_DrugID,]
Query_DrugID_knownInfo=apply(Query_DrugID_knownInfo, 2, function(x) x)
Query_DrugID_broadID=Query_DrugID_knownInfo['broad_id_trimmed']
Query_DrugID_matched=which(drugBroadID %in% Query_DrugID_broadID)[1]
if(is.na(Query_DrugID)){ print('Not in our screens')
} else{ print('It is present in our screens') }
if(is.na(Query_DrugID_matched)){ print('Present in shallow screens only(one dosage)')
} else{ print('Present in our deep screens(multiple dosages)') }

# Information gathered about drug
Query_Drug; Query_DrugID; Query_DrugID_broadID; Query_DrugID_matched; Query_DrugID_knownInfo
```

<!-- Step 0: Find Lineages with greater than 20 cell lines -->
```{r}
matched_Lineages=onTarget$annotation_20Q4$lineage[match(matched_cellLines, onTarget$annotation_20Q4$DepMap_ID)]
matched_primary_disease=onTarget$annotation_20Q4$primary_disease[
  match(matched_cellLines, onTarget$annotation_20Q4$DepMap_ID)]
matched_primary_disease_freq=table(as.character(matched_primary_disease))
primary_diseaseWD_greaterThan_20_cellLines=names(which(matched_primary_disease_freq>=20))
paste(primary_diseaseWD_greaterThan_20_cellLines,';',
      matched_primary_disease_freq[which(matched_primary_disease_freq>=20)], sep = '')
```
<!-- Step 1: Function to compute Primary-target profile in lineages with greater than 20 cell lines -->
```{r}
Find_cancer_specific_targetProfile <- function(
    infunc_cancerType_of_interest=primary_diseaseWD_greaterThan_20_cellLines[1],
    infunc_drugBroadID=Query_DrugID_broadID){
  # Lineage of Interest is denoted with LOI
  cellLines_LOI= matched_cellLines[matched_primary_disease %in% infunc_cancerType_of_interest]
  drug_matched_subsettedLOI=drug_matched[infunc_drugBroadID,cellLines_LOI]
  avana_matched_subsettedLOI=avana_matched[,cellLines_LOI]
  avana_matched_subsettedLOI=avana_matched_subsettedLOI[,!is.na(drug_matched_subsettedLOI)]
  drug_matched_subsettedLOI=na.omit(drug_matched_subsettedLOI)
  Primarytarget_profile=apply(avana_matched_subsettedLOI, 1, function(x)
    unlist(cor.test_trimmed_v0(x, drug_matched_subsettedLOI))
    )
}
```
<!-- Step 2: Call Function and preprocess results -->
```{r}
PrimaryTarget_Profile_inDiff_CanTypes=mclapply(primary_diseaseWD_greaterThan_20_cellLines, function(x)
  Find_cancer_specific_targetProfile(infunc_cancerType_of_interest=x,
                                     infunc_drugBroadID=Query_DrugID_broadID),
  mc.cores = detectCores()
  )
PrimaryTarget_Profile_inDiff_CanTypes_prep=lapply(PrimaryTarget_Profile_inDiff_CanTypes, t)
names(PrimaryTarget_Profile_inDiff_CanTypes_prep)=primary_diseaseWD_greaterThan_20_cellLines
```
<!-- See if drug specificity to its Target is more in approved cancer types vs non-aproved ones -->
```{r}
Query_Target='EGFR'
sapply(PrimaryTarget_Profile_inDiff_CanTypes_prep, function(x) x[Query_Target,2])
```
<!-- Identify all the drugs for our seven cancer types of interest -->
```{r}
secondary.screen.replicate.treatment.info=read.csv('/Users/sinhas8/Project_TrueTarget/Data/secondary-screen-replicate-treatment-info_with_Indication.csv')
drug_CLinicalInfo=secondary.screen.replicate.treatment.info[,c('broad_id','name', 'moa','target','disease.area','indication', 'phase') ]
drug_CLinicalInfo=unique(drug_CLinicalInfo)
saveRDS(drug_CLinicalInfo, '/Users/sinhas8/Project_TrueTarget/Data/drug_CLinicalInfo.RDS')
sort(table(drug_CLinicalInfo$disease.area), decreasing = T)
```

<!-- Preprocess indication nomenclature -->
```{r}
#Change 1: 'non-small cell lung cancer \\(NSCLC\\)' *to* 'Lung Cancer'
drug_CLinicalInfo$indication_processed=gsub('non-small cell lung cancer \\(NSCLC\\)','Lung Cancer',drug_CLinicalInfo$indication)
#Change 2: 'glioblastoma' to 'Brain Cancer'
drug_CLinicalInfo$indication_processed=gsub('glioblastoma','Brain Cancer',drug_CLinicalInfo$indication_processed)
drug_CLinicalInfo$indication_processed=gsub('colorectal cancer','Colon/Colorectal Cancer',drug_CLinicalInfo$indication_processed)
drug_CLinicalInfo$indication_processed=gsub('head and neck squamous cell carcinoma \\(HNSCC\\)', 'Head and Neck Cancer',drug_CLinicalInfo$indication_processed)
drug_CLinicalInfo$indication_processed=gsub('melanoma','Skin Cancer',drug_CLinicalInfo$indication_processed)
```
<!-- Extract drugs that is approved for each indication -->
```{r}
drugs_approved_for_each_indications=lapply(primary_diseaseWD_greaterThan_20_cellLines, function(x) 
  unique(drug_CLinicalInfo$name[grep(x,drug_CLinicalInfo$indication_processed, ignore.case = T)]) )
names(drugs_approved_for_each_indications)=primary_diseaseWD_greaterThan_20_cellLines
```
<!-- Step 0: Compute the DSKT in each indication -->
```{r, fig.height=8}
drugs_approved_for_each_indications_unlisted=unique(unlist(drugs_approved_for_each_indications))
CT_appDrugs=data.frame(drugname=KnownTarget_predictions$drugName[match(drugs_approved_for_each_indications_unlisted, KnownTarget_predictions$drugName)],
           Target=KnownTarget_predictions$MaxTargetName[match(drugs_approved_for_each_indications_unlisted, KnownTarget_predictions$drugName)],
           drugID=KnownTarget_predictions$drugBroadID[match(drugs_approved_for_each_indications_unlisted, KnownTarget_predictions$drugName)])

#Cancer Specific Target profile
PriTarget_in_diffCanType_list=lapply(CT_appDrugs$drugID, function(y)
  mclapply(primary_diseaseWD_greaterThan_20_cellLines, function(x)
  Find_cancer_specific_targetProfile(infunc_cancerType_of_interest=x,
                                     infunc_drugBroadID=y),
  mc.cores = detectCores()
  ))

PriTarget_in_diffCanType_list=lapply(PriTarget_in_diffCanType_list, function(x) lapply(x, t))
PriTarget_in_diffCanType_list_cor=lapply(PriTarget_in_diffCanType_list, function(x) sapply(x, function(y) y[,2] ))
# DSKT_score stands for Drug Specificity to its known Target
DSKT_score=data.frame(do.call(rbind, lapply(1:nrow(CT_appDrugs), function(x)
  err_handle(PriTarget_in_diffCanType_list_cor[[x]][CT_appDrugs$Target[x],])
  )))
colnames(DSKT_score)=primary_diseaseWD_greaterThan_20_cellLines
rownames(DSKT_score)=CT_appDrugs$drugname
DSKT_score_rank=t(apply(-DSKT_score, 1, rank))
apply(DSKT_score_rank, 1, mean)
DSKT_score_rank[1,]
CT_appDrugs_wdSpecificity=data.frame(CT_appDrugs, DSKT_score)
Heatmap(na.omit(DSKT_score))
```
<!-- Step 1: For a given drug, approved indication rank based on DSKT -->
```{r}
# err_handle_nonNA <- function(x){ tryCatch(x, error=function(e){'Error'}) }
respectiveAPPCan_CT_appDrugs <- lapply(CT_appDrugs$drugname, function(y) names(unlist(sapply(drugs_approved_for_each_indications, function(x) grep(y, x) ))) )
names(respectiveAPPCan_CT_appDrugs) <- CT_appDrugs$drugname
respectiveAPPCan_CT_appDrugs[[27]]='Lung Cancer'
```

<!-- Compute Approved vs non-approved indications DKST score -->
```{r}
#DKST based rank for approved cancers
approvedCan_rank_based_on_DKST=lapply(1:length(respectiveAPPCan_CT_appDrugs),
       function(x) 
         unlist(DSKT_score_rank[x, respectiveAPPCan_CT_appDrugs[[x]] ]) )
CT_appDrugs$CT_Rank_basedon_DKST=sapply(approvedCan_rank_based_on_DKST, mean)
#DKST based rank for NONapproved cancers
NONapprovedCan_rank_based_on_DKST=lapply(1:length(respectiveAPPCan_CT_appDrugs),
       function(x) 
         unlist(DSKT_score_rank[x, colnames(DSKT_score_rank) %!in% respectiveAPPCan_CT_appDrugs[[x]] ]) )

#DKST score for approved cancers
approvedCan_DKST=lapply(1:length(respectiveAPPCan_CT_appDrugs),
       function(x) 
         unlist(DSKT_score[x, respectiveAPPCan_CT_appDrugs[[x]] ]) )
CT_appDrugs$approvedCan_DKST=sapply(approvedCan_DKST, mean)

#DKST score for NONapproved cancers
NONapprovedCan_DKST=lapply(1:length(respectiveAPPCan_CT_appDrugs),
       function(x) 
         unlist(DSKT_score[x, colnames(DSKT_score) %!in% respectiveAPPCan_CT_appDrugs[[x]] ]) )
```
<!-- Compute various drugs properties to identify the subset we are interested in -->
```{r}
#remove drugs with NAs
remove_NAs_score=!is.na(DSKT_score[,1])
CT_appDrugs
target_overall_rank=KnownTarget_predictions$PredictedRank[match(CT_appDrugs$drugname, KnownTarget_predictions$drugName)]
DeepTarget_able2Predict_target=target_overall_rank<100
remove_egfr_inhibitors <- CT_appDrugs$moa!='EGFR inhibitor'
interestedDrugs = which(
  CT_appDrugs$is.inhibitor &
    CT_appDrugs$drug_category=='targeted cancer' &
    remove_NAs_score &
    DeepTarget_able2Predict_target &
   remove_egfr_inhibitors
)
ChemointerestedDrugs = which(
  CT_appDrugs$is.inhibitor &
    CT_appDrugs$drug_category!='targeted cancer' &
    remove_NAs_score &
    DeepTarget_able2Predict_target &
   remove_egfr_inhibitors
)
CT_appDrugs[interestedDrugs,]
# Identify the subset of drugs "CT_appDrugs" whose target is predicted correctly
```
<!-- Compare the DKST score in app vs non-approved indications -->
```{r}
mean(unlist(approvedCan_rank_based_on_DKST[interestedDrugs]))
wilcox.test(unlist(NONapprovedCan_rank_based_on_DKST[interestedDrugs]),
            unlist(approvedCan_rank_based_on_DKST[interestedDrugs]), alternative = 'g')$p.value
wilcox.test(unlist(NONapprovedCan_DKST[interestedDrugs]),
            unlist(approvedCan_DKST[interestedDrugs]), alternative = 'l')$p.value
mean(unlist(approvedCan_DKST[interestedDrugs]))/
  mean(unlist(NONapprovedCan_DKST[interestedDrugs]))
```
<!-- Compute an AUC power. -->
```{r}
dfforROC=rbind(data.frame(DSKT=unlist(approvedCan_DKST[interestedDrugs]), category='Approved'),
               data.frame(DSKT=unlist(NONapprovedCan_DKST[interestedDrugs]), category='NoTApproved'))
ChemodfforROC=rbind(data.frame(DSKT=unlist(approvedCan_DKST[ChemointerestedDrugs]), category='Approved'),
               data.frame(DSKT=unlist(NONapprovedCan_DKST[ChemointerestedDrugs]), category='NoTApproved'))
ROC_ofInterest_list=list(Targeted=roc(dfforROC$category, dfforROC$DSKT),
                         Chemo=roc(ChemodfforROC$category, ChemodfforROC$DSKT))
names(ROC_ofInterest_list)=c('Targeted=0.93',
                  'Chemo=0.57')
```
<!-- Create a boxPlot showing DKST in approved vs non-approved cancer types -->
```{r}
dfforROC$category <- factor(dfforROC$category)
levels(dfforROC$category)[2]='Not Approved'
Figure4H <- ggplot(dfforROC, aes(y=DSKT,
                                 x=str_wrap(category, 5)))+
  geom_boxplot()+
  stat_compare_means(method = 'wilcox', label = 'p')+
  theme_bw(base_size = 15)+
  labs(x='Approval Status', y='Cancer Specific DKS Score')
Figure4H
```
<!-- Plot AUC stratification power of DSKT score distribution  -->
```{r}
Figure4I <- ggroc(ROC_ofInterest_list)+ 
  theme_bw(base_size = 15) + 
  theme(legend.title = element_blank(), 
        legend.position = c(0.6, 0.2),
        legend.text = element_text(size=15),
        text = element_text(size=15),
        legend.spacing.y = unit(0, 'cm')) +
  geom_segment(aes(x = 1, xend = 0, y = 0, yend = 1), color="grey", linetype="dashed")+
  labs(title="", x="Specificity", y="Sensitivity")+
  guides(color = guide_legend(byrow = TRUE))
Figure4I
```

```{r}
DSKT_score_Targeted <- DSKT_score[CT_appDrugs$drugname[interestedDrugs],]
Figure4J <- Heatmap(DSKT_score_Targeted, name = 'DKS Score')
```
<!-- Put the above three Figures Together -->
```{r}
Figure4J_grob <- grid.grabExpr(draw(Figure4J))
Figure4Part2= grid.arrange(Figure4H,Figure4I, Figure4J_grob,
                            layout_matrix=rbind(c(1, 2, 2, 3, 3, 3))
                        )
ggsave(Figure4Part2, filename = '/Users/sinhas8/Project_TrueTarget/Results/Figure4Part2.pdf', width = 15)
ggsave(Figure4Part2, filename = '/Users/sinhas8/Project_TrueTarget/Results/Figure4Part2.png', width = 15)
ggsave(Figure4Part2, filename = '/Users/sinhas8/Project_TrueTarget/Results/Figure4Part2.png', width = 15)
```


<!-- Test what is the DKST based rank distribution overall and in various groups -->
```{r}
CT_appDrugs$drug_category=onTarget$drugCategory$drug_category[match(CT_appDrugs$drugname, onTarget$drugCategory$name)]
CT_appDrugs$is.inhibitor=onTarget$drugCategory$is.inhibitor[match(CT_appDrugs$drugname, onTarget$drugCategory$name)]
CT_appDrugs$moa=onTarget$drugCategory$moa[match(CT_appDrugs$drugname, onTarget$drugCategory$name)]
onTarget$drugCategory
CT_appDrugs_noNA <- CT_appDrugs[!is.na(CT_appDrugs$Target),]
CT_appDrugs_noNA=CT_appDrugs_noNA[CT_appDrugs_noNA$is.inhibitor,]
```
```{r}
mean(CT_appDrugs_noNA$CT_Rank_basedon_DKST)
aggregate(CT_Rank_basedon_DKST~drug_category, CT_appDrugs_noNA, mean)
score_per_moa=aggregate(CT_Rank_basedon_DKST~moa, CT_appDrugs_noNA, mean )
score_per_moa[order(score_per_moa$CT_Rank_basedon_DKST, decreasing = F),]
score_per_moa[match(names(head(sort(table(as.character(CT_appDrugs_noNA$moa)), decreasing = T), 8)), score_per_moa$moa),]
aggregate(CT_Rank_basedon_DKST~is.inhibitor, CT_appDrugs_noNA, mean)
```


Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

onTarget$drugCategory