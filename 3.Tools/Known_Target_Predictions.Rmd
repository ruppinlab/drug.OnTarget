---
title: "Known Target prediction file version update"
output: html_notebook
---

```{r}
#best Hit name
BestTargetName=apply(corrMat[,match(KnownTarget_predictions$drugBroadID, colnames(corrMat))],
                                      2, function(x) rownames(corrMat)[which.max(x)] )
BestTargetName[sapply(BestTargetName, length)==0]=NA
KnownTarget_predictions$BestTargetName=unlist(BestTargetName)

#best hit score
BestTargetCorr=apply(corrMat[,match(KnownTarget_predictions$drugBroadID, colnames(corrMat))],
                                      2, function(x) max(x, na.rm = T) )
KnownTarget_predictions$BestTargetCorr=BestTargetCorr

# Best Hit Significance
KnownTarget_predictions$BestTargetCorrP = sapply(1:nrow(KnownTarget_predictions), function(x) 
  err_handle(corrMat_P[KnownTarget_predictions[x,'BestTargetName'], KnownTarget_predictions[x,'drugBroadID']]) ) 
# Known Target Significance
KnownTarget_predictions$KnownTargetCorrP = sapply(1:nrow(KnownTarget_predictions), function(x) 
  err_handle(corrMat_P[KnownTarget_predictions[x,'MaxTargetName'], KnownTarget_predictions[x,'drugBroadID']]) ) 

corrMat_FDR=apply(corrMat_P, 2, function(x) fdrcorr(x))
# Best Hit Significance - FDR corrected
KnownTarget_predictions$BestTargetCorrFDR = sapply(1:nrow(KnownTarget_predictions), function(x) 
  err_handle(corrMat_FDR[KnownTarget_predictions[x,'BestTargetName'], KnownTarget_predictions[x,'drugBroadID']]) ) 
# Known Target Significance - FDR corrected
KnownTarget_predictions$KnownTargetCorrFDR = sapply(1:nrow(KnownTarget_predictions), function(x) 
  err_handle(corrMat_FDR[KnownTarget_predictions[x,'MaxTargetName'], KnownTarget_predictions[x,'drugBroadID']]) ) 


#Mean Expression
matched_cellLines_withExp=matched_cellLines[matched_cellLines %in% colnames(onTarget$expression_20Q4)]
KnownTarget_predictions$KnownTarget_meanCorr=sapply(KnownTarget_predictions$MaxTargetName, function(x)
  err_handle(mean(onTarget$expression_20Q4[x,matched_cellLines_withExp])) )

#Integrate Clinical Phase
KnownTarget_predictions$phase=clinicalPhase$phase[match_stripall(KnownTarget_predictions$drugName, clinicalPhase$name)]

saveRDS(KnownTarget_predictions, '/Users/sinhas8/Project_TrueTarget/Data/KnownTarget_predictions_v3.RDS')
```
