---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
knitr::knit('../3.Tools/Step0_Write_Functions.Rmd')
knitr::knit('../3.Tools/Step0B_Data_and_Libraries.Rmd')
```
<!-- Possible Search Space -->
```{r}
#GPCR
GPCR_list=read.csv('/Users/sinhas8/Downloads/Project_GPCR_ICB/Data/GPCR_list.csv')
GPCR_list=sapply(strsplit(GPCR_list$Symbol, split = '\\('), function(x) x[1])
GPCR_list=gsub(' ','',GPCR_list)
#Kinases
Kinases=human_Kinases$`HGNCÂ Name`
#Ion Channels
IonChannels=read.csv('/Users/sinhas8/Project_TrueTarget/Data/ionChannels.txt', sep = '\t')$Approved.symbol
#NuclearReceptors
NuclearReceptors=read.csv('/Users/sinhas8/Project_TrueTarget/Data/NuclearReceptors.txt', sep = '\t')$Approved.symbol
# MetabolicEnzymes
MetabolicEnzymes=readxl::read_xlsx('/Users/sinhas8/Project_TrueTarget/Data/Mammalian_Metabolic_Final.xlsx')$`Gene Symbol`
MetabolicEnzymes=toupper(MetabolicEnzymes)
#Proteases
Proteases=read.csv('/Users/sinhas8/Project_TrueTarget/Data/Proteases - Sheet1.csv')$Human
Proteases=Proteases[Proteases!='']
#phosphatase
Phosphatases=read.csv('/Users/sinhas8/Project_TrueTarget/Data/Phosphatases.txt', sep='\t')$Approved.symbol
```
<!-- A new randomization function that creates negative labels from a given restricted Space -->
```{r}
randomize_DF_with_unique_Pairs_V2_forrestricted <- function(df2randomize=Positive_Set_DrugGene_Pairs){
  df2randomize_collapsed=paste(df2randomize[,1], df2randomize[,2], sep = '_')
  fixedCol=df2randomize[,2]
  shuffledCol=sample(rownames(corrMat_rank_restrictedpace), nrow(df2randomize))
  new_df=paste(shuffledCol, fixedCol, sep = '_')
  while(sum(df2randomize_collapsed==new_df)>0){
    new_df[df2randomize_collapsed==new_df]=
      paste(sample(rownames(corrMat_rank_restrictedpace), sum(df2randomize_collapsed==new_df)),
            fixedCol[df2randomize_collapsed==new_df], sep = '_')
  }
  df2return=do.call(rbind, strsplit(new_df, '_'))
  df2return=data.frame(df2return[,1], df2return[,2])
  colnames(df2return)=colnames(df2randomize)
  df2return
}
```
<!-- Curate all kinase Inhibitors -->
```{r}
#This is the key Pivot for this snippet of code
# SEARCH_SPACE=Kinases
# SEARCH_SPACE=NuclearReceptors
# SEARCH_SPACE=GPCR_list
# SEARCH_SPACE=IonChannels
# SEARCH_SPACE=MetabolicEnzymes
# SEARCH_SPACE=Proteases
SEARCH_SPACE=Phosphatases
SEARCH_SPACE_inhibitors_id_list=sapply(SEARCH_SPACE, function(x) grep(x, onTarget$drugCategory$target) )
SEARCH_SPACE_inhibitors=onTarget$drugCategory$name[unique(unlist(SEARCH_SPACE_inhibitors_id_list))]

#Load needed GS and ROC that DeepTarget provides
ROC_list=readRDS('/Users/sinhas8/Project_TrueTarget/Data/ROC_list.RDS')
Comp_Gold_Standard_df=readRDS('/Users/sinhas8/Project_TrueTarget/Data/Comp_Gold_Standard.RDS')
# <!-- Compute what is the ROC and specificity of the model -->
# <!-- Stratifcation Score with genome-wide space only -->
SEARCH_SPACE_inhibitors_id=stripall2match(Comp_Gold_Standard_df$Chemical.Name) %in% stripall2match(SEARCH_SPACE_inhibitors)
Comp_Gold_Standard_df_restricted=Comp_Gold_Standard_df[SEARCH_SPACE_inhibitors_id,]

Comp_Gold_Standard_df_restricted_positive=Comp_Gold_Standard_df_restricted[Comp_Gold_Standard_df_restricted$Label=='Positive',1:2]
Comp_Gold_Standard_df_Genome_negative=do.call(rbind, lapply(1:10, function(x)
  randomize_DF_with_unique_Pairs_V2(Comp_Gold_Standard_df_restricted_positive)) )
Comp_Gold_Standard_df_restricted_robust=rbind(data.frame(Comp_Gold_Standard_df_restricted_positive, Label='Positive'),
                                              data.frame(Comp_Gold_Standard_df_Genome_negative, Label='Negative'))
Comp_Gold_Standard_df_restricted_robust$drug_BroadID=onTarget$drugCategory$broad_id_trimmed[
  match_stripall(Comp_Gold_Standard_df_restricted_robust$Chemical.Name, onTarget$drugCategory$name)]

# <!-- Different Kind of model Scores for genome-Search-->
#Use correlation Rank
Comp_Gold_Standard_df_restricted_robust$crispr_corr_rank=sapply(1:nrow(Comp_Gold_Standard_df_restricted_robust), function(x)
  err_handle(corrMat_rank[as.character(Comp_Gold_Standard_df_restricted_robust$Drugbank_Gene)[x],
                          as.character(Comp_Gold_Standard_df_restricted_robust$drug_BroadID)[x]]))
#Use correlation Maginitude
Comp_Gold_Standard_df_restricted_robust$crispr_corr=sapply(1:nrow(Comp_Gold_Standard_df_restricted_robust), function(x)
  err_handle(corrMat[as.character(Comp_Gold_Standard_df_restricted_robust$Drugbank_Gene)[x], as.character(Comp_Gold_Standard_df_restricted_robust$drug_BroadID)[x]]))

#ROC in case of genomw-wide search
roc_standardProcess=roc(Comp_Gold_Standard_df_restricted_robust$Label,
                        Comp_Gold_Standard_df_restricted_robust$crispr_corr_rank)

# <!-- Create a new corrMat_rank considering only the space of Human restricted -->
SEARCH_SPACE_matched=SEARCH_SPACE[SEARCH_SPACE %in% rownames(corrMat)]
total_SEARCH_SPACE_count=length(SEARCH_SPACE_matched)
corrMat_rank_restrictedpace=apply(-corrMat[SEARCH_SPACE_matched,], 2, rank)

# <!-- Create neagtive and positive labels for Kinase Inhibitors specific space-->
Comp_Gold_Standard_df_restricted_negative=do.call(rbind, lapply(1:100, function(x)
  randomize_DF_with_unique_Pairs_V2_forrestricted(Comp_Gold_Standard_df_restricted_positive)))
Comp_Gold_Standard_df_restricted_Negativesfromrestrictedpace=rbind(data.frame(Comp_Gold_Standard_df_restricted_positive, Label='Positive'),
                                                                   data.frame(Comp_Gold_Standard_df_restricted_negative, Label='Negative'))
Comp_Gold_Standard_df_restricted_Negativesfromrestrictedpace$drug_BroadID=onTarget$drugCategory$broad_id_trimmed[
  match_stripall(Comp_Gold_Standard_df_restricted_Negativesfromrestrictedpace$Chemical.Name, onTarget$drugCategory$name)]

# <!-- CRISPR Rank based on kinase space only -->
Comp_Gold_Standard_df_restricted_Negativesfromrestrictedpace$crispr_cor_rank=sapply(1:nrow(Comp_Gold_Standard_df_restricted_Negativesfromrestrictedpace), function(x)
  err_handle(corrMat_rank_restrictedpace[Comp_Gold_Standard_df_restricted_Negativesfromrestrictedpace$Drugbank_Gene[x],
                                      Comp_Gold_Standard_df_restricted_Negativesfromrestrictedpace$drug_BroadID[x]]) )
Comp_Gold_Standard_df_restricted_Negativesfromrestrictedpace$crispr_cor=sapply(1:nrow(Comp_Gold_Standard_df_restricted_Negativesfromrestrictedpace), function(x)
  err_handle(corrMat[Comp_Gold_Standard_df_restricted_Negativesfromrestrictedpace$Drugbank_Gene[x],
                     Comp_Gold_Standard_df_restricted_Negativesfromrestrictedpace$drug_BroadID[x]]) )

# <!-- Stratifcation Score with kinase space only; Cor stregnth -->
roc_restrictedpaceonly=roc(Comp_Gold_Standard_df_restricted_Negativesfromrestrictedpace$Label,
                           Comp_Gold_Standard_df_restricted_Negativesfromrestrictedpace$crispr_cor)

# <!-- Compute the proportion of possibel false positives -->
restrictedpace=Comp_Gold_Standard_df_restricted_Negativesfromrestrictedpace
GenomeSpace=Comp_Gold_Standard_df_restricted

TradeOff <- rbind(
  data.frame(FP_Prop=mean(restrictedpace$crispr_cor[restrictedpace$Label=='Positive'],na.rm = T)/nrow(corrMat),
             Space="restrcited Space",
             stratification_power=roc_restrictedpaceonly$auc),
  data.frame(FP_Prop=mean(GenomeSpace$crispr_corr[GenomeSpace$Label=='Positive'])/nrow(corrMat),
             Space="Genome-Wide",
             stratification_power=roc_standardProcess$auc)
  )
TradeOff
```


```{r}
Figure1H_data <- rbind(
  data.frame(False_Positive_Prop=mean(restrictedpace$crispr_cor[restrictedpace$Label=='Positive'],na.rm = T)/nrow(corrMat), Space="Kinase Proteins"),
  data.frame(False_Positive_Prop=mean(GenomeSpace$crispr_corr_rank[GenomeSpace$Label=='Positive'])/nrow(corrMat), Space="Genome-Wide")
  )
Figure1H_data
```

<!-- Plot the decrease of False positives proportions from the same pipeline -->
```{r}
Figure1H <- ggplot(Figure1H_data, aes(x=str_wrap(Space, 6), y=False_Positive_Prop))+
   geom_segment( aes(x=str_wrap(Space, 6), xend=str_wrap(Space, 6), y=0, yend=False_Positive_Prop), color="skyblue") +
  geom_point( color="blue", size=4, alpha=0.6) +
  theme_bw(base_size = 12) +
  labs(y='Proportion of False positives',
       x='Search Space')
ggsave(Figure1H, filename = '/Users/sinhas8/Project_TrueTarget/Results/Figure1H.pdf', width = 3)
ggsave(Figure1H, filename = '/Users/sinhas8/Project_TrueTarget/Results/Figure1H.svg', width = 3)
ggsave(Figure1H, filename = '/Users/sinhas8/Project_TrueTarget/Results/Figure1H.png', width = 3)
```
<!-- Which pathways does the targets that perform well belong to -->
```{r}
Comp_Gold_Standard_df_pos=Comp_Gold_Standard_df[Comp_Gold_Standard_df$Label=='Positive',]
head(Comp_Gold_Standard_df_pos[order(Comp_Gold_Standard_df_pos$crispr_corr),], 100)
cat(unique(Comp_Gold_Standard_df_pos$Drugbank_Gene[Comp_Gold_Standard_df_pos$crispr_corr<100]), sep='\n')
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

