---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 
<!-- Figure 3 -->
```{r}
require(ggrepel)
require(grid)
require(cowplot)
require(gridExtra)
require('stringb')
require('ggalt')
require('ggforce')
knitr::knit('/Users/sinhas8/Project_TrueTarget/Tools_github/3.Tools/Step0_Write_Functions.Rmd')
knitr::knit('/Users/sinhas8/Project_TrueTarget/Tools_github/3.Tools/Step0B_Data_and_Libraries.Rmd')
```

<!-- Predicting targets for drugs with wrongly annotated drugs or no targets -->
```{r}
cond1=onTarget$drugCategory$drug_category=='targeted cancer'
cond2=!is.na(as.character(onTarget$drugCategory$target))
cond3=sapply(strsplit(as.character(onTarget$drugCategory$target), ', '), length)==1
cond4=onTarget$drugCategory$is.inhibitor
CancerInhibitors=onTarget$drugCategory$broad_id_trimmed[cond1 & cond2 & cond4]
```
<!-- Predicting targets for drugs with wrong targets -->
```{r}

# CancerInhibitors=onTarget$drugCategory$broad_id_trimmed[cond1 & cond2 & cond3 & cond4]
CancerInhibitors_mapping=match_stripall(CancerInhibitors,
                                        KnownTarget_predictions$drugBroadID)
CancerInhibitors=KnownTarget_predictions[na.omit(CancerInhibitors_mapping),]
CancerInhibitors=unique(CancerInhibitors)
colnames(CancerInhibitors)[16]='KnownTarget_meanExp'
```
<!-- How many drugs are wrongly annotated after removing the low-expressed ones-->
```{r}
remove_not_expressed=CancerInhibitors$KnownTarget_meanExp>3
launched=CancerInhibitors$phase=='Launched'
sum(CancerInhibitors$PredictedRank[remove_not_expressed & launched]<523,
    na.rm = T)/length(CancerInhibitors$PredictedRank[which(remove_not_expressed & launched)])
sum(CancerInhibitors$PredictedRank[remove_not_expressed]<523,
    na.rm = T)/length(CancerInhibitors$PredictedRank[which(remove_not_expressed)])
```
<!-- How many drugs are wrongly annotated -->
```{r}
remove_not_expressed=CancerInhibitors$KnownTarget_meanExp>3
launched=CancerInhibitors$phase=='Launched'
CancerInhibitors$improvement_over_known=CancerInhibitors$BestTargetCorr - CancerInhibitors$Maxcorr
sum(CancerInhibitors$PredictedRank[remove_not_expressed & launched]<523,
    na.rm = T)/length(CancerInhibitors$PredictedRank[which(remove_not_expressed & launched)])
sum(CancerInhibitors$PredictedRank[remove_not_expressed]<523,
    na.rm = T)/length(CancerInhibitors$PredictedRank[which(remove_not_expressed)])
```
```{r}
sum(CancerInhibitors$PredictedRank>523 & CancerInhibitors$BestTargetCorrFDR<0.1)
sum(CancerInhibitors$PredictedRank>523 &
      CancerInhibitors$BestTargetCorrFDR<0.1 &
      CancerInhibitors$improvement_over_known>0.2)
```

<!-- Provide Annotations -->
```{r}
CancerInhibitors$category='Wrong Known target;\n No Significant Target from TrueTarget'
CancerInhibitors$category[CancerInhibitors$PredictedRank<523]='Correct Known target'
CancerInhibitors$category[CancerInhibitors$PredictedRank>523 &
                            CancerInhibitors$BestTargetCorrFDR<0.1 & 
                            CancerInhibitors$improvement_over_known>0.2]='Wrong Known target;\n Significant Target from TrueTarget'

remove_not_expressedID=which(remove_not_expressed)
CancerInhibitors_removeNotExp=CancerInhibitors[remove_not_expressedID,]
Figure3A <- ggplot(CancerInhibitors_removeNotExp,
                   aes(y=BestTargetCorr, x=Maxcorr,
                       color=category
                       ))+
  geom_point()+
  theme_bw(base_size = 12)+
  # coord_fixed()+
  theme(legend.position = 'top')+
  guides(color=guide_legend(nrow=3,byrow=TRUE))+
  labs(x='Correlation with Known Target', y='Correlation with Best\n Predicted Target')+
  geom_mark_ellipse(expand = 0)
Figure3A
```

```{r}
CancerInhibitors_removeNotExp[order(CancerInhibitors_removeNotExp$improvement_over_known, decreasing = T),]
```
<!-- How many wrong-known target drugs have a significant prediction from our pipeline -->
```{r}
Figure3B <- ggplot(CancerInhibitors_removeNotExp, aes(y=BestTargetCorr, x=PredictedRank,
                             color= category ))+
  geom_point()+
  geom_vline(xintercept = 523, linetype='dashed', color='blue')+
  theme_bw(base_size = 12)+
  theme(legend.position = 'top')+
  guides(color=guide_legend(nrow=3,byrow=TRUE))+
  labs(x='Rank of Known Target', y='Correlation with Best\n Predicted Target')
```

```{r}
CancerInhibitors_removeNotExp$drug_ann=''
cor_Threshold=0.3
To_annotate=CancerInhibitors_removeNotExp$improvement_over_known>cor_Threshold & 
  CancerInhibitors_removeNotExp$category==unique(CancerInhibitors_removeNotExp$category)[3]

#Add drug; known; predicted
CancerInhibitors_removeNotExp$drug_known_predicted_annotation=paste(CancerInhibitors_removeNotExp$drugName, CancerInhibitors_removeNotExp$MaxTargetName, CancerInhibitors_removeNotExp$BestTargetName, sep=';' )
CancerInhibitors_removeNotExp$drug_ann[To_annotate]=CancerInhibitors_removeNotExp$drug_known_predicted_annotation[To_annotate]
```

```{r}
Figure3C <- ggplot(CancerInhibitors_removeNotExp, aes(y=improvement_over_known, x=PredictedRank,
                             color= category,label=drug_ann))+
  geom_point()+
  geom_label_repel(size=2)+
  theme_bw(base_size = 12)+
  # theme(legend.position = 'none')+
  geom_vline(xintercept = 523, linetype='dashed', color='blue')+
  geom_hline(yintercept = 0.2, linetype='dashed', color='blue')+
  labs(x='Predicted Rank of Known Target', y='Improvement score of\nPredicted Target over Known')
```

```{r}
cat_ofInterest=CancerInhibitors_removeNotExp$category==unique(CancerInhibitors_removeNotExp$category)[3]
CancerInhibitors_removeNotExp_cat_ofInterest=CancerInhibitors_removeNotExp[cat_ofInterest,]
CancerInhibitors_removeNotExp_cat_ofInterest[grep('Launched',CancerInhibitors_removeNotExp_cat_ofInterest$phase),]
CancerInhibitors_removeNotExp_cat_ofInterest[grep('Launched',CancerInhibitors_removeNotExp_cat_ofInterest$phase),]
```
<!-- Figure 3D data -->
```{r}
figure3D_data=data.frame(table(CancerInhibitors_removeNotExp_cat_ofInterest$phase))
Figure3D <- ggplot(figure3D_data, aes(y=Freq, x=Var1))+
  geom_segment( aes(x=Var1, xend=Var1, y=0, yend=Freq), color="skyblue") +
  geom_point( color="blue", size=4, alpha=0.6)+
   theme_bw(base_size = 12) +
  coord_flip()+
  labs(y='Drugs with alternative\npredicted target',x='Drugs Category')
```

<!-- Strophanthidin target is known as ATP1A1 but our pipeline predicts it as PSMD5 -->
```{r}
CurrWrong_Target='ATP1A1'; DOI='strophanthidin'; BestPredicted_Target='PSMD5'
# sum(expression_matched[CurrWrong_Target,]<3)
DOI_id=KnownTarget_predictions$drugBroadID[grep('strophanthidin', KnownTarget_predictions$drugName)]
Figure3E_data=rbind(data.frame(Target='Currently Known Target',
                               TargetName=CurrWrong_Target,
                               CRISPR_KO=avana_matched[CurrWrong_Target,],
                               drug_response=drug_matched[DOI_id,]),
                    data.frame(Target='Predicted Target',
                               TargetName=BestPredicted_Target,
                               CRISPR_KO=avana_matched[BestPredicted_Target,],
                               drug_response=drug_matched[DOI_id,]
                               )
                    )


Figure3E <- ggplot(Figure3E_data, aes(x=CRISPR_KO, y=drug_response))+
  geom_point()+
  stat_smooth(method = 'lm', se = T)+
  facet_wrap(.~Target+TargetName, scales = 'free')+
  theme_bw(base_size = 12)+
  labs(x='Viability after CRISPR-KO',
       y=paste('Response to', DOI))+
  stat_cor(size=4)+
  theme(legend.position = 'top')
Figure3E
# ggsave(Figure3E, filename = '/Users/sinhas8/Project_TrueTarget/Results/FigureS9v0.png',
#        width = 6, height = 4)
# ggsave(Figure3E, filename = '/Users/sinhas8/Project_TrueTarget/Results/FigureS9v0.pdf',
#        width = 6, height = 4)
```
<!-- Ones that are wrongly annotated -->
```{r}
KnownTarget_predictions=unique(KnownTarget_predictions)

#### Condition for wrongly annotated 
cond1=!is.na(KnownTarget_predictions$PredictedRank)
cond2=KnownTarget_predictions$PredictedRank>523
cond3=grepl('targeted cancer', KnownTarget_predictions$drugCategory)
cond4=KnownTarget_predictions$BestTargetCorrFDR<0.05
cond5=KnownTarget_predictions$BestTargetCorr-KnownTarget_predictions$Maxcorr>0.2
cond6=KnownTarget_predictions$KnownTarget_meanCorr>3
WronglyAnnotated=KnownTarget_predictions[which(cond1 & cond2 & cond4 & cond5 & cond6),]
dim(WronglyAnnotated)

#predicted pathway
predicted_pathway_annotation=sapply(1:nrow(WronglyAnnotated),function(y)
  names(na.omit(sapply(names(hallmark_pathway), function(x) match(WronglyAnnotated$BestTargetName[y], hallmark_pathway[[x]])))[1]) )
WronglyAnnotated$predictedPathway=predicted_pathway_annotation

Known_pathway_annotation=sapply(1:nrow(WronglyAnnotated),function(y)
  names(na.omit(sapply(names(hallmark_pathway), function(x) match(WronglyAnnotated$MaxTargetName[y], hallmark_pathway[[x]])))[1]) )
WronglyAnnotated$Known_pathway_annotation=Known_pathway_annotation
WronglyAnnotated
wrong2correctPathway=data.frame(table(WronglyAnnotated$Known_pathway_annotation, WronglyAnnotated$predictedPathway))
wrong2correctPathway=wrong2correctPathway[wrong2correctPathway$Freq!=0,]
mean_corr_df=aggregate(WronglyAnnotated$BestTargetCorr - WronglyAnnotated$Maxcorr,
                    by =list(WronglyAnnotated$Known_pathway_annotation, WronglyAnnotated$predictedPathway), mean)
wrong2correctPathway$mean_corr=mean_corr_df$x
```


```{r}
wrong2correctPathway$Var2=gsub('_',' ',gsub('HALLMARK_','',wrong2correctPathway$Var2))
wrong2correctPathway$Var1=gsub('_',' ',gsub('HALLMARK_','',wrong2correctPathway$Var1))
Figure3F <- ggplot(data = wrong2correctPathway,
       aes(axis1 = Var1, axis2 = str_wrap(Var2, 30), y = Freq)) +
  geom_alluvium(aes(fill=mean_corr)) +
  geom_stratum() +
  geom_text(stat = "stratum",
            aes(label = after_stat(stratum)), size=2) +
  scale_x_discrete(limits = c("Var1", "Var2"),
                   expand = c(0.15, 0.05)) +
  theme_void(base_size = 12) +
  guides(fill = guide_legend(title = "DKS score"))
Figure3F
ggsave(Figure3F, filename = '/Users/sinhas8/Project_TrueTarget/Results/Figure3F.png',
       width = 11, height = 5)
ggsave(Figure3F, filename = '/Users/sinhas8/Project_TrueTarget/Results/Figure3F.pdf',
       width = 11, height = 5)
```

```{r}
Figure3ABC=ggarrange(Figure3A, Figure3B, Figure3C, 
                     labels = 'AUTO', nrow = 1,ncol = 3,
                     common.legend = TRUE,
                     legend="top")
Figure3 <- grid.arrange(Figure3ABC, Figure3D, Figure3E, nrow = 2,
                        layout_matrix = rbind(c(1, 1, 1),c(1, 1, 1),c(1, 1, 1),c(2, 3, 3), c(2, 3, 3)) )

ggsave(Figure3, filename = '/Users/sinhas8/Project_TrueTarget/Results/Figure3v0.png',
       width = 10, height = 6)
ggsave(Figure3, filename = '/Users/sinhas8/Project_TrueTarget/Results/Figure3v0.pdf',
       width = 10, height = 6)
```


```{r}
Figure3v2=grid.arrange(Figure3, Figure3F, layout_matrix=rbind(c(1,1,1,1,1,1),c(1,1,1,1,1,1),c(NA,2,2,2,2,NA)))
ggsave(Figure3v2, filename = '/Users/sinhas8/Project_TrueTarget/Results/Figure3v0.png',
       width = 10, height = 9)
ggsave(Figure3v2, filename = '/Users/sinhas8/Project_TrueTarget/Results/Figure3v0.pdf',
       width = 10, height = 9)
```

```

```{r}
onTarget$drugCategory[grep('decitabine',onTarget$drugCategory$name),]

CancerInhibitors_removeNotExp[cat_ofInterest,]$phase
CancerInhibitors[grep('DNMT1', CancerInhibitors$MaxTargetName ),]
```

```{r}
CancerInhibitors_removeNotExp_cat_ofInterest[order(CancerInhibitors_removeNotExp_cat_ofInterest$improvement_over_known, decreasing = T),-c(4:11,14:16)]
CancerInhibitors_removeNotExp_cat_ofInterest[order(CancerInhibitors_removeNotExp_cat_ofInterest$BestTargetCorr, decreasing = T),-c(4:11,14:16)]
CancerInhibitors_removeNotExp_cat_ofInterest[grep('Launched',CancerInhibitors_removeNotExp_cat_ofInterest$phase),]
```
```{r}
cat(CancerInhibitors_removeNotExp_cat_ofInterest$MaxTargetName, sep = '\n')
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

