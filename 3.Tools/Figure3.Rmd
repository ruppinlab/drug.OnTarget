---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 
<!-- Figure 3 -->
<!-- Predicting targets for drugs with wrongly annotated drugs or no targets -->
```{r}
cond1=onTarget$drugCategory$drug_category=='targeted cancer'
cond2=!is.na(as.character(onTarget$drugCategory$target))
cond3=sapply(strsplit(as.character(onTarget$drugCategory$target), ', '), length)==1
cond4=onTarget$drugCategory$is.inhibitor
```

<!-- Predicting targets for drugs with no targets -->
```{r}
CancerInhibitors=onTarget$drugCategory$broad_id_trimmed[cond1 & cond2 & cond4]
# CancerInhibitors=onTarget$drugCategory$broad_id_trimmed[cond1 & cond2 & cond3 & cond4]
CancerInhibitors_mapping=match_stripall(CancerInhibitors,
                                        KnownTarget_predictions$drugBroadID)
CancerInhibitors=KnownTarget_predictions[na.omit(CancerInhibitors_mapping),]
CancerInhibitors=unique(CancerInhibitors)
dim(CancerInhibitors)
```
<!-- How many drugs are wrongly annotated after removing the low-expressed ones-->
```{r}
remove_not_expressed=CancerInhibitors$KnownTarget_meanCorr>3
launched=CancerInhibitors$phase=='Launched'
sum(CancerInhibitors$PredictedRank[remove_not_expressed & launched]<523,
    na.rm = T)/length(CancerInhibitors$PredictedRank[which(remove_not_expressed & launched)])
sum(CancerInhibitors$PredictedRank[remove_not_expressed]<523,
    na.rm = T)/length(CancerInhibitors$PredictedRank[which(remove_not_expressed)])
```
<!-- How many drugs are wrongly annotated -->
```{r}
remove_not_expressed=CancerInhibitors$KnownTarget_meanCorr>3
launched=CancerInhibitors$phase=='Launched'
sum(CancerInhibitors$PredictedRank[remove_not_expressed & launched]<523,
    na.rm = T)/length(CancerInhibitors$PredictedRank[which(remove_not_expressed & launched)])
sum(CancerInhibitors$PredictedRank[remove_not_expressed]>523,
    na.rm = T)/length(CancerInhibitors$PredictedRank[which(remove_not_expressed)])
dim(KnownTarget_predictions)
```

```{r}
CancerInhibitors$category='Wrong Known target'
CancerInhibitors$category[CancerInhibitors$PredictedRank<523]='Correct Known target'
CancerInhibitors[order(CancerInhibitors$BestTargetCorr - CancerInhibitors$Maxcorr, decreasing = T),-(4:11)]
CancerInhibitors$improvement_over_known=CancerInhibitors$BestTargetCorr - CancerInhibitors$Maxcorr
sum(is.na(CancerInhibitors$category))
remove_not_expressedID=which(remove_not_expressed)
Figure3A <- ggplot(CancerInhibitors[remove_not_expressedID,], aes(y=BestTargetCorr, x=Maxcorr, color=category))+
  geom_point()+
  theme_bw(base_size = 18)+
  coord_fixed()+
  theme(legend.position = 'top')+
  guides(color=guide_legend(nrow=2,byrow=TRUE))+
  labs(x='Correlation with Known Target', y='Correlation with Best\n Predicted Target')
```
<!-- How many wrong-known target drugs have a significant prediction from our pipeline -->
```{r}
sum(CancerInhibitors[remove_not_expressedID,]$PredictedRank>523 &
      CancerInhibitors[remove_not_expressedID,]$BestTargetCorrP<0.001)
```


```{r}
ggsave(Figure3A, filename = '/Users/sinhas8/Project_TrueTarget/Results/Figure3A.pdf',
       width = 5, height = 4.5)
ggsave(Figure3A, filename = '/Users/sinhas8/Project_TrueTarget/Results/Figure3A.png',
       width = 5, height = 4.5)
```


```{r}
FigureS5 <- ggplot(CancerInhibitors[remove_not_expressedID,], aes(y=BestTargetCorr, x=PredictedRank,
                             color= category ))+
  geom_point()+
  geom_vline(xintercept = 523, linetype='dashed', color='blue')+
  theme_bw(base_size = 18)+
  theme(legend.position = 'top')+
  guides(color=guide_legend(nrow=2,byrow=TRUE))+
  labs(x='Rank of Known Target', y='Correlation with Best\n Predicted Target')
ggsave(FigureS5, filename = '/Users/sinhas8/Project_TrueTarget/Results/FigureS5.pdf',
       width = 5, height = 4.5)
ggsave(FigureS5, filename = '/Users/sinhas8/Project_TrueTarget/Results/FigureS5.png',
       width = 5, height = 4.5)
```

```{r}
CancerInhibitors$drug_ann=''
cor_Threshold=0.3
CancerInhibitors$drug_ann[CancerInhibitors$improvement_over_known>cor_Threshold]=
  paste(CancerInhibitors$drugName, CancerInhibitors$MaxTargetName, CancerInhibitors$BestTargetName, sep=';' )[CancerInhibitors$improvement_over_known>cor_Threshold]
length(unique(CancerInhibitors$drugName))
```
<!-- These are drugs whose predicted target is incorrect & we can predict a high confidence Target-->
```{r}
Drugs_with_wrongTargetID=CancerInhibitors$PredictedRank>523
Drugs_with_wrongTargetID_highConfidenceFrmTT=Drugs_with_wrongTargetID & 
  CancerInhibitors$BestTargetCorrP<0.001 & 
  CancerInhibitors$KnownTarget_meanCorr>1 & 
  CancerInhibitors$improvement_over_known>0.2
sum(Drugs_with_wrongTargetID_highConfidenceFrmTT)
CancerInhibitors_WT_HC=CancerInhibitors[Drugs_with_wrongTargetID_highConfidenceFrmTT,]
```
```{r}
CancerInhibitors_WT_HC=CancerInhibitors_WT_HC[order(CancerInhibitors_WT_HC$improvement_over_known, decreasing = T),]
CancerInhibitors_WT_HC[which(CancerInhibitors_WT_HC$phase=='Launched'),]
table(CancerInhibitors_WT_HC$phase)
```


```{r}
ggplot(CancerInhibitors, aes(y=improvement_over_known, x=PredictedRank,
                             color= PredictedRank>523 & BestTargetCorrP<0.001 & KnownTarget_meanCorr>1
                             ,
                             label=drug_ann))+
  geom_point()+
  geom_label_repel(size=2)+
  theme_bw(base_size = 12)+
  theme(legend.position = 'none')+
  geom_vline(xintercept = 523, linetype='dashed', color='blue')
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

