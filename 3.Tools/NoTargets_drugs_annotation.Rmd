---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 
<!-- Figure 4 -->
```{r}
require(ggrepel)
require(grid)
require(cowplot)
require(gridExtra)
require('stringb')
require('ggalt')
require('ggforce')
knitr::knit('/Users/sinhas8/Project_TrueTarget/Tools_github/3.Tools/Step0_Write_Functions.Rmd')
knitr::knit('/Users/sinhas8/Project_TrueTarget/Tools_github/3.Tools/Step0B_Data_and_Libraries.Rmd')
```

<!-- Predicting targets for drugs with no targets -->
```{r}
cond1=onTarget$drugCategory$drug_category=='targeted cancer'
cond2=is.na(as.character(onTarget$drugCategory$target))
```
<!-- Predicting targets for drugs with wrong targets -->
```{r}
CancerInhibitors_noTargets=onTarget$drugCategory$broad_id_trimmed[cond1 & cond2]
CancerInhibitors_mapping=match_stripall(CancerInhibitors_noTargets,
                                        KnownTarget_predictions$drugBroadID)
CancerInhibitors_noTargets=KnownTarget_predictions[na.omit(CancerInhibitors_mapping),]
CancerInhibitors_noTargets=unique(CancerInhibitors_noTargets)
dim(CancerInhibitors_noTargets)
```
<!-- Ones where we can identify significant target & target correlation is greater than 0.25-->
```{r}
cond3=CancerInhibitors_noTargets$BestTargetCorrFDR<0.05
# cond4=CancerInhibitors_noTargets$BestTargetCorr>0.25
CancerInhibitors_noTargets_withsigTargets=CancerInhibitors_noTargets[cond3,-(2:11)]
CancerInhibitors_noTargets_withsigTargets[order(CancerInhibitors_noTargets_withsigTargets$BestTargetCorr, decreasing = T),]

```

```{r}
CancerInhibitors_noTargets[grep('Launched',CancerInhibitors_noTargets$phase),]
```

<!-- How many drugs are wrongly annotated after removing the low-expressed ones-->
```{r}
remove_not_expressed=CancerInhibitors$KnownTarget_meanCorr>3
launched=CancerInhibitors$phase=='Launched'
sum(CancerInhibitors$PredictedRank[remove_not_expressed & launched]<523,
    na.rm = T)/length(CancerInhibitors$PredictedRank[which(remove_not_expressed & launched)])
sum(CancerInhibitors$PredictedRank[remove_not_expressed]<523,
    na.rm = T)/length(CancerInhibitors$PredictedRank[which(remove_not_expressed)])
```
<!-- How many drugs are wrongly annotated -->
```{r}
remove_not_expressed=CancerInhibitors$KnownTarget_meanCorr>3
launched=CancerInhibitors$phase=='Launched'
CancerInhibitors$improvement_over_known=CancerInhibitors$BestTargetCorr - CancerInhibitors$Maxcorr
sum(CancerInhibitors$PredictedRank[remove_not_expressed & launched]<523,
    na.rm = T)/length(CancerInhibitors$PredictedRank[which(remove_not_expressed & launched)])
sum(CancerInhibitors$PredictedRank[remove_not_expressed]<523,
    na.rm = T)/length(CancerInhibitors$PredictedRank[which(remove_not_expressed)])
```
```{r}
sum(CancerInhibitors$PredictedRank>523 & CancerInhibitors$BestTargetCorrFDR<0.1)
sum(CancerInhibitors$PredictedRank>523 &
      CancerInhibitors$BestTargetCorrFDR<0.1 &
      CancerInhibitors$improvement_over_known>0.2)
```

<!-- Provide Annotations -->
```{r}
CancerInhibitors$category='Wrong Known target;\n No Significant Target from TrueTarget'
CancerInhibitors$category[CancerInhibitors$PredictedRank<523]='Correct Known target'
CancerInhibitors$category[CancerInhibitors$PredictedRank>523 &
                            CancerInhibitors$BestTargetCorrFDR<0.1 & 
                            CancerInhibitors$improvement_over_known>0.2]='Wrong Known target;\n Significant Target from TrueTarget'

remove_not_expressedID=which(remove_not_expressed)
CancerInhibitors_removeNotExp=CancerInhibitors[remove_not_expressedID,]
Figure3A <- ggplot(CancerInhibitors_removeNotExp,
                   aes(y=BestTargetCorr, x=Maxcorr,
                       color=category
                       ))+
  geom_point()+
  theme_bw(base_size = 18)+
  coord_fixed()+
  theme(legend.position = 'top')+
  guides(color=guide_legend(nrow=3,byrow=TRUE))+
  labs(x='Correlation with Known Target', y='Correlation with Best\n Predicted Target')+
  geom_mark_ellipse(expand = 0)
Figure3A
```
```{r}
CancerInhibitors_removeNotExp[order(CancerInhibitors_removeNotExp$improvement_over_known, decreasing = T),]
```

```{r}
ggsave(Figure3A, filename = '/Users/sinhas8/Project_TrueTarget/Results/Figure3A.pdf',
       width = 6, height = 6)
ggsave(Figure3A, filename = '/Users/sinhas8/Project_TrueTarget/Results/Figure3A.png',
       width = 6, height = 6)
```

<!-- How many wrong-known target drugs have a significant prediction from our pipeline -->
```{r}
Figure3B <- ggplot(CancerInhibitors_removeNotExp, aes(y=BestTargetCorr, x=PredictedRank,
                             color= category ))+
  geom_point()+
  geom_vline(xintercept = 523, linetype='dashed', color='blue')+
  theme_bw(base_size = 18)+
  theme(legend.position = 'top')+
  guides(color=guide_legend(nrow=3,byrow=TRUE))+
  labs(x='Rank of Known Target', y='Correlation with Best\n Predicted Target')
```

```{r}
ggsave(Figure3B, filename = '/Users/sinhas8/Project_TrueTarget/Results/Figure3B.pdf',
       width = 6, height = 6)
ggsave(Figure3B, filename = '/Users/sinhas8/Project_TrueTarget/Results/Figure3B.png',
       width = 6, height = 6)
```

```{r}
CancerInhibitors_removeNotExp$drug_ann=''
cor_Threshold=0.3
To_annotate=CancerInhibitors_removeNotExp$improvement_over_known>cor_Threshold & 
  CancerInhibitors_removeNotExp$category==unique(CancerInhibitors_removeNotExp$category)[3]

#Add drug; known; predicted
CancerInhibitors_removeNotExp$drug_known_predicted_annotation=paste(CancerInhibitors_removeNotExp$drugName, CancerInhibitors_removeNotExp$MaxTargetName, CancerInhibitors_removeNotExp$BestTargetName, sep=';' )
CancerInhibitors_removeNotExp$drug_ann[To_annotate]=CancerInhibitors_removeNotExp$drug_known_predicted_annotation[To_annotate]
```
<!-- These are drugs whose predicted target is incorrect & we can predict a high confidence Target-->
```{r}
CancerInhibitors_WT_HC=CancerInhibitors_WT_HC[order(CancerInhibitors_WT_HC$improvement_over_known, decreasing = T),]
CancerInhibitors_WT_HC[which(CancerInhibitors_WT_HC$phase=='Launched'),]
table(CancerInhibitors_WT_HC$phase)
```


```{r}
Figure3C <- ggplot(CancerInhibitors_removeNotExp, aes(y=improvement_over_known, x=PredictedRank,
                             color= category,label=drug_ann))+
  geom_point()+
  geom_label_repel(size=2)+
  theme_bw(base_size = 18)+
  # theme(legend.position = 'none')+
  geom_vline(xintercept = 523, linetype='dashed', color='blue')+
  labs(x='Predicted Rank of Known Target', y='Improvement score of\nPredicted Target over Known')
```

```{r}
Figure3ABC=ggarrange(Figure3A, Figure3B, Figure3C, 
                     labels = 'AUTO', nrow = 2,ncol = 2,
                     common.legend = TRUE,
                     legend="top")
ggsave(Figure3ABC, filename = '/Users/sinhas8/Project_TrueTarget/Results/Figure3ABC_v0.png',
       width = 12, height = 12)
ggsave(Figure3ABC, filename = '/Users/sinhas8/Project_TrueTarget/Results/Figure3ABC_v0.pdf',
       width = 12, height = 12)
```

```{r}
cat_ofInterest=CancerInhibitors_removeNotExp$category==unique(CancerInhibitors_removeNotExp$category)[3]
CancerInhibitors_removeNotExp_cat_ofInterest=CancerInhibitors_removeNotExp[cat_ofInterest,]
CancerInhibitors_removeNotExp_cat_ofInterest[grep('Launched',CancerInhibitors_removeNotExp_cat_ofInterest$phase),]
CancerInhibitors_removeNotExp_cat_ofInterest[grep('Launched',CancerInhibitors_removeNotExp_cat_ofInterest$phase),]
```
<!-- Figure 3D data -->
```{r}
figure3D_data=data.frame(table(CancerInhibitors_removeNotExp_cat_ofInterest$phase))
Figure3D <- ggplot(figure3D_data, aes(y=Freq, x=Var1))+
  geom_segment( aes(x=Var1, xend=Var1, y=0, yend=Freq), color="skyblue") +
  geom_point( color="blue", size=4, alpha=0.6)+
   theme_bw(base_size = 18) +
  coord_flip()+
  labs(y='Drugs with alternative\npredicted target',x='Drugs Category')

Figure3ABCD <- grid.arrange(Figure3ABC, Figure3D, nrow = 2,
             layout_matrix = rbind(c(1, 1, 1),c(1, 1, 1),c(1, 1, 1), c(1, 1, 1), c(NA, 2, NA)) )

```

```{r}
ggsave(Figure3ABCD, filename = '/Users/sinhas8/Project_TrueTarget/Results/Figure3ABCD_v0.png',
       width = 12, height = 15)
ggsave(Figure3ABCD, filename = '/Users/sinhas8/Project_TrueTarget/Results/Figure3ABCD_v0.pdf',
       width = 12, height = 15)
```

```{r}
onTarget$drugCategory[grep('decitabine',onTarget$drugCategory$name),]

CancerInhibitors_removeNotExp[cat_ofInterest,]$phase
CancerInhibitors[grep('DNMT1', CancerInhibitors$MaxTargetName ),]
```

```{r}
CancerInhibitors_removeNotExp_cat_ofInterest[order(CancerInhibitors_removeNotExp_cat_ofInterest$improvement_over_known, decreasing = T),-c(4:11,14:16)]
CancerInhibitors_removeNotExp_cat_ofInterest[order(CancerInhibitors_removeNotExp_cat_ofInterest$BestTargetCorr, decreasing = T),-c(4:11,14:16)]
CancerInhibitors_removeNotExp_cat_ofInterest[grep('Launched',CancerInhibitors_removeNotExp_cat_ofInterest$phase),]
```
```{r}
cat(CancerInhibitors_removeNotExp_cat_ofInterest$MaxTargetName, sep = '\n')
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

