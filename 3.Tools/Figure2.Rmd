---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
require(ggrepel)
require(grid)
require(cowplot)
require(gridExtra)
require(tidyverse)
require('stringb')
knitr::knit('/Users/sinhas8/Project_TrueTarget/Tools_github/3.Tools/Step0_Write_Functions.Rmd')
knitr::knit('/Users/sinhas8/Project_TrueTarget/Tools_github/3.Tools/Step0B_Data_and_Libraries.Rmd')
```
<!-- Filter drugs that are targeted therapy, have targets, single target, is inhibitor & is expressed -->
```{r}
cond1=onTarget$drugCategory$drug_category=='targeted cancer'
cond2=!is.na(as.character(onTarget$drugCategory$target))
cond3=sapply(strsplit(as.character(onTarget$drugCategory$target), ', '), length)==1
cond4=onTarget$drugCategory$is.inhibitor
```


```{r}
singleCancerInhibitors=onTarget$drugCategory$broad_id_trimmed[cond1 & cond2 & cond3 & cond4]
singleCancerInhibitors_mapping=match_stripall(singleCancerInhibitors,
                                              KnownTarget_predictions$drugBroadID)
df2plot_single=KnownTarget_predictions[na.omit(singleCancerInhibitors_mapping),]
cond5=df2plot_single$KnownTarget_meanCorr>3
df2plot_single=df2plot_single[cond5,]
df2plot_single=unique(df2plot_single[,c('drugName', 'Maxcorr', 'MaxTargetName', 'PredictedRank')])
df2plot_single$TrueTarget_Predicted='Known Target is wrong'
df2plot_single$TrueTarget_Predicted[df2plot_single$PredictedRank<523]='Known Target is correct'
```
<!-- Plot Figure 2B -->
```{r}
Figure2B <- ggplot(df2plot_single, aes(x=Maxcorr,
                                       y=PredictedRank,
                                       color=TrueTarget_Predicted))+
  geom_point()+
  theme_bw(base_size = 12)+
  labs(x='Correlation of drug response\n& known target CRISPR-KO',
       y='', color='True Target Prediction')+
  scale_y_reverse()+
  geom_text_repel(data = df2plot_single[df2plot_single$PredictedRank<2 & df2plot_single$Maxcorr>0.33,], 
                  aes(x=Maxcorr, y=PredictedRank,label=paste(drugName, MaxTargetName, sep = ':')),
                  nudge_y = seq(-5000, -16000,-4000),
                  nudge_x = seq(-0.5, 0.8, 0.4),
                  max.overlaps = 1, size=3)+
  geom_hline(yintercept = 523, linetype='dashed', color='blue')
Figure2B
```


```{r}
cond1=onTarget$drugCategory$drug_category=='targeted cancer'
cond2=!is.na(as.character(onTarget$drugCategory$target))
cond4=onTarget$drugCategory$is.inhibitor
singleCancerInhibitors=onTarget$drugCategory$broad_id_trimmed[cond1 & cond2 & cond4]
singleCancerInhibitors_mapping=match_stripall(singleCancerInhibitors,
                                              KnownTarget_predictions$drugBroadID)
df2plot=KnownTarget_predictions[na.omit(singleCancerInhibitors_mapping),]
cond5=df2plot$KnownTarget_meanCorr>3
df2plot=df2plot[cond5,]
df2plot=unique(df2plot[,c('drugName', 'Maxcorr', 'MaxTargetName', 'PredictedRank')])
df2plot$TrueTarget_Predicted='Known Target is wrong'
df2plot$TrueTarget_Predicted[df2plot$PredictedRank<523]='Known Target is correct'
df2plot$TrueTarget_Predicted=factor(df2plot$TrueTarget_Predicted)
# df2plot$TrueTarget_Predicted=fct_rev(df2plot$TrueTarget_Predicted)
df2plot
Figure2A <- ggplot(df2plot, aes(x=Maxcorr,
                                       y=PredictedRank,
                                       color=TrueTarget_Predicted))+
  geom_point()+
  theme_bw(base_size = 12)+
  labs(x=text_wrap(''),
       y='Genome-Wide Rank', color='True Target Prediction')+
  scale_y_reverse()+
  geom_text_repel(data = df2plot[df2plot$PredictedRank==1 & df2plot$Maxcorr>0.38,], 
                  aes(x=Maxcorr, y=PredictedRank,label=paste(drugName, MaxTargetName, sep = ':')),
                  nudge_y = seq(-5000, -18000,-3000),
                  nudge_x = seq(-0.5, 0.8, 0.2), max.overlaps = 1, size=3)+
  geom_hline(yintercept = 523, linetype='dashed', color='blue')
Figure2A
```

```{r}
clinicalPhase=read.csv('/Users/sinhas8/Project_TrueTarget/Data/biomarkers.csv')
df2plot$stage=clinicalPhase$phase[match_stripall(df2plot$drugName, clinicalPhase$name)]
# df2plot=na.omit(df2plot)
df2plot_launched=df2plot[df2plot$stage=='Launched',]
Figure2C <- ggplot(na.omit(df2plot_launched),
                   aes(x=Maxcorr,y=PredictedRank,color=TrueTarget_Predicted))+
  geom_point()+
  theme_bw(base_size = 12)+
  labs(x=text_wrap(''),
       y='', color='True Target Prediction')+
  scale_y_reverse()+
  geom_text_repel(data = df2plot_launched[df2plot_launched$PredictedRank<10,], 
                  aes(x=Maxcorr, y=PredictedRank,label=paste(drugName, MaxTargetName, sep = ':')),
                    nudge_y = seq(-5000, -10000,-1000),
                  nudge_x = seq(-0.5, 0.2, 0.1), max.overlaps = 1, size=3)+
  geom_hline(yintercept = 523, linetype='dashed', color='blue')
Figure2C
```

```{r}
figure2D_data=data.frame(Category=c('Targeted Inhibitor', 'Single Targeted Inhibitor', 'Approved Targeted Inhibitor'),
Prop_corr_ann=c(sum(df2plot$PredictedRank<523, na.rm = T)/length(na.omit(df2plot$PredictedRank)),
                sum(df2plot_single$PredictedRank<523)/length(df2plot_single$PredictedRank),
                sum(df2plot_launched$PredictedRank<523, na.rm = T)/length(na.omit(df2plot_launched$PredictedRank))))
Figure2D <- ggplot(figure2D_data, aes(y=Prop_corr_ann, x=str_wrap(Category, 5)))+
  geom_segment( aes(x=str_wrap(Category, 5), xend=str_wrap(Category, 5),
                    y=0, yend=Prop_corr_ann), color="skyblue") +
  geom_point(color="blue", size=4, alpha=0.6)+
   theme_bw(base_size = 10) +
  coord_flip()+
  labs(y='Proportion of Drugs\n with correct known Target',x='Drugs Category')
```

<!-- Figure 4E -->
```{r, fig.width=10}
KnownTarget_predictions$clinical_stage=factor(KnownTarget_predictions$phase)
levels(KnownTarget_predictions$clinical_stage)=c(4, 1, 2, 2, 3, 3, 0, -1)
KnownTarget_predictions$phase_trimmed=factor(KnownTarget_predictions$phase)
levels(KnownTarget_predictions$phase_trimmed)=c("Launched","Phase 1","Phase 2", "Phase 2","Phase 3", "Phase 3", "Preclinical", "Withdrawn")

top_drugs_of_interest=which(KnownTarget_predictions$MaxTargetName %in% c('EGFR','MAP2K1', 'MET'))
clinical_advancement=unique(KnownTarget_predictions[top_drugs_of_interest,])
dim(clinical_advancement)

diff_CLin_stages_comb= combn(as.character(na.omit(unique(clinical_advancement$phase_trimmed))),2, simplify = F)

clinical_advancement$phase_trimmed=factor(clinical_advancement$phase_trimmed)
clinical_advancement$clinical_stage=factor2numeric(clinical_advancement$clinical_stage)
clinical_advancement=clinical_advancement[!is.na(clinical_advancement$clinical_stage),]
Figure2E= ggplot(clinical_advancement, 
                  aes(x= reorder(factor(phase_trimmed),clinical_stage), 
                      y= Maxcorr,
                      color= clinical_stage))+
  geom_boxplot()+
  stat_compare_means(comparisons = diff_CLin_stages_comb, size=2)+
  theme_bw(base_size = 12)+
  stat_smooth(method = 'lm', se= T, level = 0.8,
              span= 1, aes(group= 1), linetype= 'dotted', size= 0.8)+
  labs(y='DKS Score', x='Clinical Stages')+
  facet_wrap(.~MaxTargetName, scales = 'free')+
  theme(legend.position = 'right')+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
Figure2E
sort(table(KnownTarget_predictions$MaxTargetName), decreasing = T)
```

```{r}
Figure2ABC=ggarrange(Figure2A, Figure2B, Figure2C, 
                     labels = 'AUTO', nrow = 1,common.legend = TRUE, legend="top")
Figure2 <- grid.arrange(Figure2ABC, Figure2D, Figure2E,
                        layout_matrix = rbind(c(1, 1, 1, 1),c(1, 1, 1, 1),c(2, 3, 3, 3),c(NA, 3, 3, 3)) )
ggsave(Figure2, filename = '/Users/sinhas8/Project_TrueTarget/Results/Figure2v0.png',
       width = 10, height = 8)
ggsave(Figure2, filename = '/Users/sinhas8/Project_TrueTarget/Results/Figure2v0.pdf',
       width = 10, height = 8)
```


Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

