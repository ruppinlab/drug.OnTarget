---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
require(ggrepel)
knitr::knit('/Users/sinhas8/Project_TrueTarget/Tools_github/3.Tools/Step0_Write_Functions.Rmd')
knitr::knit('/Users/sinhas8/Project_TrueTarget/Tools_github/3.Tools/Step0B_Data_and_Libraries.Rmd')
```

```{r}
cond1=onTarget$drugCategory$drug_category=='targeted cancer'
cond2=!is.na(as.character(onTarget$drugCategory$target))
cond3=sapply(strsplit(as.character(onTarget$drugCategory$target), ', '), length)==1
cond4=onTarget$drugCategory$is.inhibitor
singleCancerInhibitors=onTarget$drugCategory$broad_id_trimmed[cond1 & cond2 & cond3 & cond4]
# singleCancerInhibitors=onTarget$drugCategory$broad_id_trimmed[cond1 & cond2 & cond4]
singleCancerInhibitors_mapping=match_stripall(singleCancerInhibitors,
                                              KnownTarget_predictions$drugBroadID)
df2plot_single=KnownTarget_predictions[na.omit(singleCancerInhibitors_mapping),]
df2plot_single=unique(df2plot_single[,c('drugName', 'Maxcorr', 'MaxTargetName', 'PredictedRank')])
Figure2A <- ggplot(df2plot_single, aes(x=Maxcorr, y=PredictedRank))+
  geom_point()+
  theme_bw(base_size = 18)+
  labs(x='Correlation of drug response & known target CRISPR-KO', y='Genome-Wide Rank')+
  scale_y_reverse()+
  geom_text_repel(data = df2plot_single[df2plot_single$PredictedRank<10,], 
                  aes(x=Maxcorr, y=PredictedRank,label=paste(drugName, MaxTargetName, sep = ':')),
                  nudge_y = seq(-5000, -16000,-1000),
                  nudge_x = seq(-0.5, 0.8, 0.1), max.overlaps = 1)
```

```{r}
cond1=onTarget$drugCategory$drug_category=='targeted cancer'
cond2=!is.na(as.character(onTarget$drugCategory$target))
cond3=sapply(strsplit(as.character(onTarget$drugCategory$target), ', '), length)==1
cond4=onTarget$drugCategory$is.inhibitor
# singleCancerInhibitors=onTarget$drugCategory$broad_id_trimmed[cond1 & cond2 & cond3 & cond4]
singleCancerInhibitors=onTarget$drugCategory$broad_id_trimmed[cond1 & cond2 & cond4]
singleCancerInhibitors_mapping=match_stripall(singleCancerInhibitors,
                                              KnownTarget_predictions$drugBroadID)
df2plot=KnownTarget_predictions[na.omit(singleCancerInhibitors_mapping),]
df2plot=unique(df2plot[,c('drugName', 'Maxcorr', 'MaxTargetName', 'PredictedRank')])
Figure2B <- ggplot(df2plot, aes(x=Maxcorr, y=PredictedRank))+
  geom_point()+
  theme_bw(base_size = 18)+
  labs(x='Correlation of drug response & known target CRISPR-KO', y='Genome-Wide Rank')+
  scale_y_reverse()+
  geom_text_repel(data = df2plot[df2plot$Maxcorr>0.3,], 
                  aes(x=Maxcorr, y=PredictedRank,label=paste(drugName, MaxTargetName, sep = ':')),
                  nudge_y = seq(-5000, -16000,-1000),
                  nudge_x = seq(-0.5, 0.8, 0.1), max.overlaps = 1)
```

```{r}
clinicalPhase=read.csv('/Users/sinhas8/Project_TrueTarget/Data/biomarkers.csv')
df2plot$stage=clinicalPhase$phase[match_stripall(df2plot$drugName, clinicalPhase$name)]
df2plot=na.omit(df2plot)
df2plot_launched=df2plot[df2plot$stage=='Launched',]
Figure2C <- ggplot(df2plot_launched, aes(x=Maxcorr, y=PredictedRank))+
  geom_point()+
  theme_bw(base_size = 18)+
  labs(x='Correlation of drug response & known target CRISPR-KO', y='Genome-Wide Rank')+
  scale_y_reverse()+
  geom_text_repel(data = df2plot_launched,
                  aes(x=Maxcorr, y=PredictedRank,label=paste(drugName, MaxTargetName, sep = ':')))
```

```{r}
Figure2ABC=ggarrange(Figure2A, Figure2B, Figure2C, labels = 'AUTO', nrow = 3)
ggsave(Figure2ABC, filename = '/Users/sinhas8/Project_TrueTarget/Results/Figure2AB_v0.png',
       width = 8, height = 15)
ggsave(Figure2ABC, filename = '/Users/sinhas8/Project_TrueTarget/Results/Figure2AB_v0.pdf',
       width = 8, height = 15)
```

```{r}
sum(df2plot_single$PredictedRank<523)/length(df2plot_single$PredictedRank)
sum(df2plot$PredictedRank==1)/length(df2plot$PredictedRank)
sum(df2plot_launched$PredictedRank<523)/length(df2plot_launched$PredictedRank)
```


Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

