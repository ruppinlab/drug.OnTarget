---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 
<!-- Landscape of differential targeting drugs -->
<!-- Correlation between BRAF inhibitor phase and BRAF V600E specificity -->
```{r}
#Mutation interaction corr with clinical advancement
KnownTarget_predictions$Stage=factor(KnownTarget_predictions$phase)
levels(KnownTarget_predictions$Stage)=c(4,1,2, 2, 3, 3, 0, -1)
cor.test(factor2numeric(KnownTarget_predictions$Stage)[braf_id],
         KnownTarget_predictions$mutation_interaction_strength[braf_id])

mut_diffential_targeting_drugs=KnownTarget_predictions[which(KnownTarget_predictions$mutation_interaction_P<0.05),]
KnownTarget_predictions[which(KnownTarget_predictions$mutation_interaction_P<0.05),-c(4:7, 8:19)]
#Mutation interaction corr with target corr
# egfr_id=grep('EGFR',KnownTarget_predictions$MaxTargetName)
braf_id=grep('BRAF',KnownTarget_predictions$MaxTargetName)

df2plot_Data_figure5E=KnownTarget_predictions[braf_id,]
```
<!-- Plot 5F: Correlation between BRAF inhibitor phase and BRAF V600E specificity -->
```{r}
df2plot_Data_figure5E$phase=factor(df2plot_Data_figure5E$phase)
levels(df2plot_Data_figure5E$phase)[2]='Phase1-2'
Figure5F <- ggplot(df2plot_Data_figure5E, aes(x=reorder(phase, mutation_interaction_strength), y=mutation_interaction_strength))+
  geom_boxplot()+
  theme_bw(base_size = 15)+
  labs(x='Clinical Phases', y='Extent of differential targeting\nof V600E')+
  stat_compare_means(comparisons = combn(levels(df2plot_Data_figure5E$phase), 2, simplify = F))+
  theme(axis.text.x = element_text(size=10, angle = -20, vjust = -0.4))
Figure5F
```
<!-- Figure 5G - Landscape of all differential binding -->
```{r}
Figure5G_data=KnownTarget_predictions
Figure5G_data$ann=''
Figure5G_data$ann=paste(Figure5G_data$drugName, Figure5G_data$MaxTargetName,sep=';')
Figure5G_data[grep('BRAF',Figure5G_data$MaxTargetName),]


Figure5G <- ggplot(Figure5G_data, aes(y= mutation_interaction_strength,
                                     x= -log10(mutation_interaction_P),
                                     color= mutation_interaction_P<0.05,
                                     label= ann))+
  geom_point()+
  theme_bw(base_size = 15)+
  theme(legend.position = 'none')+
  geom_label_repel(data = subset(Figure5G_data,
                                 Figure5G_data$mutation_interaction_P<0.01))+
  geom_vline(xintercept = 1.3, linetype='dashed',color='blue')+
  labs(x='-log10(Significance)', y='Differential targeting to\nmutant vs WT')
Figure5G
```
<!-- Extract Figure5H Data -->
```{r}
mut_diffential_targeting_drugs[grep('BRAF',mut_diffential_targeting_drugs$MaxTargetName),]
GOI='BRAF';DOI='Dabrafenib'
DOI_id=mut_diffential_targeting_drugs$drugBroadID[match_stripall( DOI, mut_diffential_targeting_drugs$drugName)]
Figure5H_data=data.frame(crispr=avana_matched['BRAF',], Dabrafenib=drug_matched[DOI_id,], BRAF_mutation=mutation_matched['BRAF',])
Figure5H_data$BRAF_mutation=factor(Figure5H_data$BRAF_mutation)
levels(Figure5H_data$BRAF_mutation)=c('WT', 'V600E')
Figure5H <- ggplot(Figure5H_data, aes(x=crispr, y=Dabrafenib, color=factor(BRAF_mutation)))+
  # geom_point()+
  stat_smooth(method = 'lm')+
  theme_bw(base_size = 15)+
  labs(x='Viability after BRAF CRISPR-KO', y='Response to Dabrafenib', color='BRAF\nmutation\nstatus')+
  stat_cor(label.y = c(1.3,1.4))
```
<!-- Putting all Figure together -->
```{r}
# Figure5 <-ggarrange(Figure4A, Figure4E, Figure4C,
#           Figure4B,Figure4F,Figure4D,
#           Figure5F, Figure5G, Figure5H,
#           nrow = 3, ncol=3, labels = 'AUTO',
#                     font.label = list(size = 20))
# ggsave(Figure5, filename = '/Users/sinhas8/Project_TrueTarget/Results/Figure5v1.png',
#        width = 14, height = 12)
# ggsave(Figure5, filename = '/Users/sinhas8/Project_TrueTarget/Results/Figure5v1.pdf',
#        width = 14, height = 12)
```
```{r}
Figure5 <-grid.arrange(Figure5H, Figure5G,
                       Figure4A, Figure4E, Figure4C,
                       Figure4B,Figure4F,Figure4D,
                       Figure5F, Figure5J, Figure5K,
                       layout_matrix = rbind(c(1, 1,1, 2, 2, 2), c(3,3, 4,4, 5,5), c(6,6, 7,7, 8,8), c(9,9,10,10,11,11))
                       )
ggsave(Figure5, filename = '/Users/sinhas8/Project_TrueTarget/Results/Figure5v2.png',
       width = 10, height = 12)
ggsave(Figure5, filename = '/Users/sinhas8/Project_TrueTarget/Results/Figure5v2.pdf',
       width = 10, height = 12)
```



<!-- Find genes that are most frequenty targeted by differential targeting drugs -->
```{r}
more2mutant=which(mut_diffential_targeting_drugs$mutation_interaction_strength>0)
not_low_expresed=which(mut_diffential_targeting_drugs$KnownTarget_meanCorr>3)
more2WT=which(mut_diffential_targeting_drugs$mutation_interaction_strength<0)
sort(table(mut_diffential_targeting_drugs$MaxTargetName[intersect(more2mutant, not_low_expresed)]), decreasing = T)
sort(table(mut_diffential_targeting_drugs$MaxTargetName[intersect(more2WT, not_low_expresed)]), decreasing = T)
```

<!-- Extract Figure5H Data -->
```{r}
mut_diffential_targeting_drugs_approved=mut_diffential_targeting_drugs[which(mut_diffential_targeting_drugs$phase=='Launched'),]
mut_diffential_targeting_drugs_approved[
  order(mut_diffential_targeting_drugs_approved$mutation_interaction_strength*
          (-log10(mut_diffential_targeting_drugs_approved$mutation_interaction_P))),]

GOI='PARP1';DOI='olaparib'
DOI_id=mut_diffential_targeting_drugs$drugBroadID[match_stripall( DOI, mut_diffential_targeting_drugs$drugName)]
Figure5J_data=data.frame(crispr=avana_matched[GOI,], drug_response=drug_matched[DOI_id,], mutation=mutation_matched[GOI,])
Figure5J_data$mutation=factor(Figure5J_data$mutation)
levels(Figure5J_data$mutation)=c('WT', 'mutant')
Figure5J <- ggplot(Figure5J_data, aes(x=crispr, y=drug_response, color=factor(mutation)))+
  # geom_point()+
  stat_smooth(method = 'lm', se=F)+
  theme_bw(base_size = 15)+
  labs(x='Viability after PARP CRISPR-KO', y='Response to Olaparib', color='PARP1\nmutation\nstatus')+
  stat_cor(label.y = c(1.2,1.3), size=3)
```

```{r}
mut_diffential_targeting_drugs_approved=mut_diffential_targeting_drugs[which(mut_diffential_targeting_drugs$phase=='Launched'),]
mut_diffential_targeting_drugs_approved[
  order(mut_diffential_targeting_drugs_approved$mutation_interaction_strength*
          (-log10(mut_diffential_targeting_drugs_approved$mutation_interaction_P))),]

mut_diffential_targeting_drugs[grep('TUBA1B',mut_diffential_targeting_drugs$MaxTargetName),]
GOI='TUBA1B';DOI='vinorelbine'
DOI_id=mut_diffential_targeting_drugs$drugBroadID[match_stripall( DOI, mut_diffential_targeting_drugs$drugName)]
Figure5J_data=data.frame(crispr=avana_matched[GOI,], drug_response=drug_matched[DOI_id,], mutation=mutation_matched[GOI,])
Figure5J_data$mutation=factor(Figure5J_data$mutation)
levels(Figure5J_data$mutation)=c('WT', 'mutant')
Figure5K <- ggplot(Figure5J_data, aes(x=crispr, y=drug_response, color=factor(mutation)))+
  # geom_point()+
  stat_smooth(method = 'lm', se = F)+
  theme_bw(base_size = 12)+
  labs(x='Viability after TUBB CRISPR-KO', y='Response to oxibendazole', color='TUBB\nmutation\nstatus')+
  stat_cor(label.y = c(0.8,0.9), size=3)
Figure5K
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

