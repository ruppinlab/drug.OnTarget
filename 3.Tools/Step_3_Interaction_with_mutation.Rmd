---
title: "Intraction with mutation"
output: html_document
---

```{r}
# th= 
mutation_data= onTarget$mutations_matrix[, depid_of_interest]

  
lm_cmat_with_intraction_with_mutation= as.data.frame(do.call(rbind, sapply(cmat_drug_name,function (x) 
    err_handle(
      summary(lm(drug_response_with_common_celline[x,]~ crispr_with_common_celline[correlation_mat_df[x ,'Target'],]*
         factor(mutation_data[correlation_mat_df[ x ,'Target'],])))$coefficients[4,c(1,4)] )))) 

lm_cmat_with_intraction_with_mutation=  na.omit(lm_cmat_with_intraction_with_mutation)
colnames(lm_cmat_with_intraction_with_mutation)[c(1,2)]= c('intraction_estimate', 'pvalue')
lm_cmat_with_intraction_with_mutation$Target= correlation_mat_df$Target[match(rownames(lm_cmat_with_intraction_with_mutation),
                                                                                  rownames(correlation_mat_df))]
lm_cmat_with_intraction_with_mutation$drug_name= onTarget$drugCategory$name[match(rownames(lm_cmat_with_intraction_with_mutation),
                                                                                  onTarget$drugCategory$broad_id_trimmed)]

lm_cmat_with_intraction_with_mutation[grep('ibru', lm_cmat_with_intraction_with_mutation$drug_name),]
```

```{r}
drug_cat[grep('ibru', drug_cat$name),]

x= 'K70301465'
drug_response= drug_response_with_common_celline[x,]
viability= crispr_with_common_celline[correlation_mat_df[ x ,'Target'],]
mut= factor(mutation_data[correlation_mat_df[ x ,'Target'],])
fit = lm(drug_response ~ viability * mut)
summary(fit)

require(statar)
#### intraction plot
interact_plot(model = fit, 
              pred = viability, 
              modx = mut,
              # modx.values = "terciles",
              interval = F,
              int.width = 0.95
            # ,
            # linearity.check = TRUE
            )+ theme_bw()
```


```{r}
ggplot(lm_cmat_with_intraction_with_mutation, aes(x=intraction_estimate))+
  geom_histogram()
```
```{r}
match_rows= match(rownames(lm_cmat_with_intraction_with_mutation), rownames(correlation_mat_df))

cor.test(correlation_mat_df[match_rows,'cor_estimate'],(lm_cmat_with_intraction_with_mutation[,'intraction_estimate']))

df2plot_2= data.frame(cor_estimate=correlation_mat_df[match_rows,'cor_estimate'],
                    intraction_estimate= lm_cmat_with_intraction_with_mutation[,'intraction_estimate'],
                    pvalue=lm_cmat_with_intraction_with_mutation$pvalue,  
                    row.names = rownames(lm_cmat_with_intraction_with_mutation))

ggplot(df2plot_2, aes(x=intraction_estimate, y= (cor_estimate)))+
  geom_point(size=1, shape= 22, aes(color= pvalue < 0.05) )+
  geom_smooth(method = "lm", se= F)+
  stat_cor()
```
```{r}
ggplot(na.omit(df2plot_2), aes(x=-log10(pvalue), y= (cor_estimate)))+
  geom_point(size=1, shape= 22, aes(color= (intraction_estimate > 0)))+
  geom_smooth(method = "lm", se= F)+
  stat_cor(label.y.npc = "top")
```

```{r}
df2plot_2$cor_estimateQ=factor(xtile(df2plot_2$cor_estimate, 5))
df2plot_2$log10P= -log10(df2plot_2$pvalue)
df2plot_2$conditionOFInterest=df2plot_2$pvalue <0.1 & df2plot_2$intraction_estimate >0
aggregate_df2plot_2=aggregate(df2plot_2$conditionOFInterest, list(df2plot_2$cor_estimateQ), function(x) sum(x)/length(x))
colnames(aggregate_df2plot_2)=c('corEstimate', 'Conditions_matched_Proportion')
ggplot(aggregate_df2plot_2, aes(y=Conditions_matched_Proportion, x=corEstimate))+
  geom_bar(stat = 'identity')+
  theme_bw(base_size = 15)
```




